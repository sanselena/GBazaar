@{
    ViewData["Title"] = "Product & Department Management";
}

<div class="cosmic-container">
    <div class="cosmic-header">
        <div class="cosmic-header__icon">
            <i class="fas fa-boxes"></i>
        </div>
        <div class="cosmic-header__content">
            <h1 class="cosmic-header__title">Product & Department Management</h1>
            <p class="cosmic-header__subtitle">Manage products catalog and departments</p>
        </div>
        <div class="cosmic-header__actions">
            <button class="cosmic-btn cosmic-btn--primary" onclick="openCreateProductModal()">
                <i class="fas fa-box"></i>
                <span>Add Product</span>
            </button>
            <button class="cosmic-btn cosmic-btn--secondary" onclick="openCreateDepartmentModal()">
                <i class="fas fa-building"></i>
                <span>Add Department</span>
            </button>
            <a href="/Admin/Dashboard" class="cosmic-btn cosmic-btn--secondary">
                <i class="fas fa-arrow-left"></i>
                <span>Back to Dashboard</span>
            </a>
        </div>
    </div>

    @if (TempData["AdminSuccess"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["AdminSuccess"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["AdminError"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["AdminError"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Products Section -->
    <div class="cosmic-card" style="margin-bottom: 40px;">
        <div class="cosmic-card__header">
            <h3 class="cosmic-card__title">
                <i class="fas fa-box"></i>
                Product List (@((ViewBag.Products as IEnumerable<GBazaar.Models.Product>)?.Count() ?? 0) products)
            </h3>
            <div class="cosmic-search">
                <i class="fas fa-search"></i>
                <input type="text" class="cosmic-search__input" placeholder="Search products..." id="productSearch">
            </div>
        </div>

        <div class="cosmic-table-wrapper">
            <table class="cosmic-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Product Name</th>
                        <th>Description</th>
                        <th>Unit Price</th>
                        <th>Unit of Measure</th>
                        <th>Supplier</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    @if (ViewBag.Products != null && ((IEnumerable<GBazaar.Models.Product>)ViewBag.Products).Any())
                    {
                        @foreach (var product in (IEnumerable<GBazaar.Models.Product>)ViewBag.Products)
                        {
                            <tr>
                                <td>@product.ProductID</td>
                                <td>
                                    <div class="user-cell">
                                        <div class="product-icon">
                                            <i class="fas fa-box"></i>
                                        </div>
                                        <span>@product.ProductName</span>
                                    </div>
                                </td>
                                <td title="@(product.Description ?? "N/A")">
                                    @if (!string.IsNullOrEmpty(product.Description))
                                    {
                                        @(product.Description.Length > 50 ? product.Description.Substring(0, 50) + "..." : product.Description)
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>
                                <td>
                                    @if (product.UnitPrice.HasValue)
                                    {
                                        <span class="price-badge">₺@product.UnitPrice.Value.ToString("N2")</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted">N/A</span>
                                    }
                                </td>
                                <td>@(product.UnitOfMeasure ?? "N/A")</td>
                                <td>
                                    <span class="supplier-badge">
                                        <i class="fas fa-building"></i>
                                        @(product.Supplier?.SupplierName ?? "Unknown")
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="action-btn action-btn--view" title="View Details" onclick="viewProduct(@product.ProductID)">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="action-btn action-btn--delete" title="Delete Product" onclick="deleteProduct(@product.ProductID, '@Html.Raw(Html.Encode(product.ProductName))')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.6);">
                                <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 15px; display: block;"></i>
                                No products found
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <!-- Departments Section -->
    <div class="cosmic-card">
        <div class="cosmic-card__header">
            <h3 class="cosmic-card__title">
                <i class="fas fa-building"></i>
                Department List
            </h3>
            <div style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Total: @((ViewBag.Departments as IEnumerable<GBazaar.Models.Department>)?.Count() ?? 0) Departments
            </div>
        </div>

        <div class="department-grid">
            @if (ViewBag.Departments != null && ((IEnumerable<GBazaar.Models.Department>)ViewBag.Departments).Any())
            {
                @foreach (var dept in (IEnumerable<GBazaar.Models.Department>)ViewBag.Departments)
                {
                    var userCount = dept.Users?.Count ?? 0;
                    var totalBudget = dept.Budgets?.Sum(b => b.TotalBudget) ?? 0;
                    <div class="department-card">
                        <div class="department-card__header">
                            <div class="department-card__icon">
                                <i class="fas fa-building"></i>
                            </div>
                            <button class="department-card__delete" onclick="deleteDepartment(@dept.DepartmentID, '@Html.Raw(Html.Encode(dept.DepartmentName))')" title="Delete Department">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                        <h4 class="department-card__title">@dept.DepartmentName</h4>
                        <p class="department-card__description">Budget Code: @dept.BudgetCode</p>
                        <div class="department-card__stats">
                            <div class="department-stat">
                                <i class="fas fa-users"></i>
                                <span>@userCount Users</span>
                            </div>
                            <div class="department-stat">
                                <i class="fas fa-dollar-sign"></i>
                                <span>₺@totalBudget.ToString("N2")</span>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: rgba(255, 255, 255, 0.6);">
                    <i class="fas fa-inbox" style="font-size: 4rem; margin-bottom: 20px; display: block;"></i>
                    <p style="font-size: 1.2rem;">No departments found</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Create Product Modal -->
<div id="createProductModal" class="cosmic-modal">
    <div class="cosmic-modal__overlay" onclick="closeCreateProductModal()"></div>
    <div class="cosmic-modal__content">
        <div class="cosmic-modal__header">
            <h3 class="cosmic-modal__title">
                <i class="fas fa-box"></i>
                Add New Product
            </h3>
            <button class="cosmic-modal__close" onclick="closeCreateProductModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form class="cosmic-form" method="post" action="/Admin/CreateProduct">
            @Html.AntiForgeryToken()
            <div class="cosmic-form__row">
                <div class="cosmic-form__group">
                    <label class="cosmic-form__label">Product Name *</label>
                    <input type="text" name="ProductName" class="cosmic-form__input" placeholder="Enter product name" required>
                </div>
                <div class="cosmic-form__group">
                    <label class="cosmic-form__label">Supplier *</label>
                    <select name="SupplierID" class="cosmic-form__select" required>
                        <option value="">Select supplier...</option>
                    </select>
                </div>
            </div>

            <div class="cosmic-form__row">
                <div class="cosmic-form__group">
                    <label class="cosmic-form__label">Unit Price</label>
                    <input type="number" name="UnitPrice" class="cosmic-form__input" placeholder="0.00" step="0.01" min="0">
                </div>
                <div class="cosmic-form__group">
                    <label class="cosmic-form__label">Unit of Measure</label>
                    <select name="UnitOfMeasure" class="cosmic-form__select">
                        <option value="">Select unit...</option>
                        <option value="pcs">Pieces</option>
                        <option value="kg">Kilograms</option>
                        <option value="ltr">Liters</option>
                        <option value="mt">Meters</option>
                        <option value="pkg">Package</option>
                        <option value="box">Box</option>
                        <option value="set">Set</option>
                    </select>
                </div>
            </div>

            <div class="cosmic-form__row">
                <div class="cosmic-form__group cosmic-form__group--full">
                    <label class="cosmic-form__label">Description</label>
                    <textarea name="Description" class="cosmic-form__textarea" placeholder="Enter product description" rows="3"></textarea>
                </div>
            </div>

            <div class="cosmic-form__actions">
                <button type="button" class="cosmic-btn cosmic-btn--secondary" onclick="closeCreateProductModal()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="submit" class="cosmic-btn cosmic-btn--primary">
                    <i class="fas fa-save"></i>
                    Add Product
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Create Department Modal -->
<div id="createDepartmentModal" class="cosmic-modal">
    <div class="cosmic-modal__overlay" onclick="closeCreateDepartmentModal()"></div>
    <div class="cosmic-modal__content" style="max-width: 600px;">
        <div class="cosmic-modal__header">
            <h3 class="cosmic-modal__title">
                <i class="fas fa-building"></i>
                Add New Department
            </h3>
            <button class="cosmic-modal__close" onclick="closeCreateDepartmentModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form class="cosmic-form" method="post" action="/Admin/CreateDepartment">
            @Html.AntiForgeryToken()
            <div class="cosmic-form__row">
                <div class="cosmic-form__group" style="grid-column: 1 / -1;">
                    <label class="cosmic-form__label">Department Name *</label>
                    <input type="text" name="DepartmentName" class="cosmic-form__input" placeholder="Enter department name" required>
                </div>
            </div>

            <div class="cosmic-form__row">
                <div class="cosmic-form__group">
                    <label class="cosmic-form__label">Budget Code *</label>
                    <input type="text" name="BudgetCode" class="cosmic-form__input" placeholder="e.g., IT-2024" required>
                </div>
                <div class="cosmic-form__group">
                    <label class="cosmic-form__label">Budget Amount *</label>
                    <input type="number" name="BudgetAmount" class="cosmic-form__input" placeholder="0.00" step="0.01" required>
                </div>
            </div>

            <div class="cosmic-form__row">
                <div class="cosmic-form__group" style="grid-column: 1 / -1;">
                    <label class="cosmic-form__label">Description</label>
                    <textarea name="Description" class="cosmic-form__input" rows="3" placeholder="Enter department description"></textarea>
                </div>
            </div>

            <div class="cosmic-form__actions">
                <button type="button" class="cosmic-btn cosmic-btn--secondary" onclick="closeCreateDepartmentModal()">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="submit" class="cosmic-btn cosmic-btn--primary">
                    <i class="fas fa-save"></i>
                    Add Department
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function openCreateProductModal() {
            loadSuppliers();
            document.getElementById('createProductModal').classList.add('cosmic-modal--active');
            document.body.style.overflow = 'hidden';
        }

        function closeCreateProductModal() {
            document.getElementById('createProductModal').classList.remove('cosmic-modal--active');
            document.body.style.overflow = '';
        }

        function openCreateDepartmentModal() {
            document.getElementById('createDepartmentModal').classList.add('cosmic-modal--active');
            document.body.style.overflow = 'hidden';
        }

        function closeCreateDepartmentModal() {
            document.getElementById('createDepartmentModal').classList.remove('cosmic-modal--active');
            document.body.style.overflow = '';
        }

        function loadSuppliers() {
            fetch('/Admin/GetSuppliers')
                .then(response => response.json())
                .then(suppliers => {
                    const supplierSelect = document.querySelector('#createProductModal select[name="SupplierID"]');
                    supplierSelect.innerHTML = '<option value="">Select supplier...</option>';
                    suppliers.forEach(supplier => {
                        supplierSelect.innerHTML += `<option value="${supplier.supplierID}">${supplier.supplierName}</option>`;
                    });
                })
                .catch(error => console.error('Error loading suppliers:', error));
        }

        function viewProduct(productId) {
            // Implement product details view
            alert('Product details view will be implemented.');
        }

        function deleteProduct(productId, productName) {
            if (confirm(`Are you sure you want to delete product "${productName}"?`)) {
                fetch('/Admin/DeleteProduct', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: productId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error deleting product: ' + error);
                });
            }
        }

        function deleteDepartment(deptId, deptName) {
            if (confirm(`Are you sure you want to delete department "${deptName}"?\n\nWarning: This may affect users assigned to this department.`)) {
                fetch('/Admin/DeleteDepartment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: deptId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error deleting department: ' + error);
                });
            }
        }

        // Search functionality for products
        document.getElementById('productSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#productTableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        });
    </script>
}